suite: test deployment
templates:
  - deployment.yaml
tests:
  - it: should create deployment with default values
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-vaultwarden
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.template.spec.containers[0].image
          value: vaultwarden/server:1.34.3

  - it: should set custom replica count
    set:
      replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should use custom image tag
    set:
      image.tag: "1.30.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: vaultwarden/server:1.30.0

  - it: should configure sqlite database by default
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ENABLE_DB_WAL
            value: "true"

  - it: should configure external mysql database
    set:
      database.type: mysql
      database.url: "mysql://user:pass@host/db"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DATABASE_URL
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-vaultwarden
                key: database-url
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ENABLE_DB_WAL
            value: "false"

  - it: should configure external postgresql database
    set:
      database.type: postgresql
      database.url: "postgresql://user:pass@host/db"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DATABASE_URL
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-vaultwarden
                key: database-url

  - it: should use existing secret for database
    set:
      database.type: postgresql
      database.existingSecret: my-db-secret
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DATABASE_URL
            valueFrom:
              secretKeyRef:
                name: my-db-secret
                key: database-url

  - it: should set domain when provided
    set:
      vaultwarden.domain: "https://vault.example.com"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DOMAIN
            value: "https://vault.example.com"

  - it: should configure signups
    set:
      vaultwarden.allowSignups: false
      vaultwarden.verifySignup: true
      vaultwarden.smtp.enabled: true
      vaultwarden.smtp.host: smtp.example.com
      vaultwarden.smtp.from: vault@example.com
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SIGNUPS_ALLOWED
            value: "false"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SIGNUPS_VERIFY
            value: "true"

  - it: should mount persistence volume when enabled
    set:
      persistence.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: RELEASE-NAME-vaultwarden
            mountPath: /data
      - contains:
          path: spec.template.spec.volumes
          content:
            name: RELEASE-NAME-vaultwarden
            persistentVolumeClaim:
              claimName: RELEASE-NAME-vaultwarden

  - it: should use custom volume when specified
    set:
      customVolume:
        hostPath:
          path: /data/vaultwarden
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: RELEASE-NAME-vaultwarden
            hostPath:
              path: /data/vaultwarden

  - it: should set resources
    set:
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 128Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 128Mi

  - it: should set security contexts
    set:
      podSecurityContext:
        fsGroup: 1000
      securityContext:
        runAsUser: 1000
        allowPrivilegeEscalation: false
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1000
