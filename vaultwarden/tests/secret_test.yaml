suite: test secret
templates:
  - secret.yaml
tests:
  - it: should not create secret by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create secret for admin token
    set:
      vaultwarden.admin.enabled: true
    asserts:
      - isKind:
          of: Secret
      - isNotEmpty:
          path: data['admin-token']

  - it: should create secret for external database
    set:
      database.type: mysql
      database.url: "mysql://user:pass@host/db"
    asserts:
      - isKind:
          of: Secret
      - isNotEmpty:
          path: data['database-url']

  - it: should not create secret when using existing secrets
    set:
      vaultwarden.admin.enabled: true
      vaultwarden.admin.existingSecret: my-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should create secret with SMTP credentials
    set:
      vaultwarden.smtp.enabled: true
      vaultwarden.smtp.host: smtp.example.com
      vaultwarden.smtp.from: vault@example.com
      vaultwarden.smtp.user: smtp-user
      vaultwarden.smtp.password: smtp-pass
    asserts:
      - isKind:
          of: Secret
      - isNotEmpty:
          path: data['smtp-user']
      - isNotEmpty:
          path: data['smtp-password']

  - it: should not create secret when using existing SMTP secret
    set:
      vaultwarden.smtp.enabled: true
      vaultwarden.smtp.host: smtp.example.com
      vaultwarden.smtp.from: vault@example.com
      vaultwarden.smtp.existingSecret: my-smtp-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should create secret with Yubico credentials
    set:
      vaultwarden.yubico.enabled: true
      vaultwarden.yubico.clientId: "12345"
      vaultwarden.yubico.secretKey: "secret123"
    asserts:
      - isKind:
          of: Secret
      - isNotEmpty:
          path: data['yubico-client-id']
      - isNotEmpty:
          path: data['yubico-secret-key']

  - it: should not create secret when using existing Yubico secret
    set:
      vaultwarden.yubico.existingSecret: my-yubico-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should create secret with push notification credentials
    set:
      vaultwarden.push.enabled: true
      vaultwarden.push.installationId: "install-123"
      vaultwarden.push.installationKey: "key-456"
    asserts:
      - isKind:
          of: Secret
      - isNotEmpty:
          path: data['push-id']
      - isNotEmpty:
          path: data['push-key']

  - it: should not create secret when using existing push secret
    set:
      vaultwarden.push.enabled: true
      vaultwarden.push.existingSecret: my-push-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should create secret with multiple credentials
    set:
      vaultwarden.admin.enabled: true
      database.type: postgresql
      database.url: "postgresql://user:pass@host/db"
      vaultwarden.smtp.enabled: true
      vaultwarden.smtp.host: smtp.example.com
      vaultwarden.smtp.from: vault@example.com
      vaultwarden.smtp.user: smtp-user
      vaultwarden.smtp.password: smtp-pass
      vaultwarden.yubico.enabled: true
      vaultwarden.yubico.clientId: "12345"
      vaultwarden.yubico.secretKey: "secret123"
    asserts:
      - isKind:
          of: Secret
      - isNotEmpty:
          path: data['admin-token']
      - isNotEmpty:
          path: data['database-url']
      - isNotEmpty:
          path: data['smtp-user']
      - isNotEmpty:
          path: data['smtp-password']
      - isNotEmpty:
          path: data['yubico-client-id']
      - isNotEmpty:
          path: data['yubico-secret-key']
